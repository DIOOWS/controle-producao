import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import os
import plotly.express as px

# =======================
# CONFIGURA√á√ïES GERAIS
# =======================
PRODUCAO_FILE = "producao.csv"
DESPERDICIO_FILE = "desperdicio.csv"

# Cores fixas da semana
CORES_DIAS = {
    "monday": "azul",
    "tuesday": "verde",
    "wednesday": "amarelo",
    "thursday": "laranja",
    "friday": "vermelho",
    "saturday": "prata",
    "sunday": "dourado"
}

# Emojis visuais das cores
def emoji_cor(cor):
    cores_emoji = {
        "azul": "üü¶",
        "verde": "üü©",
        "amarelo": "üü®",
        "laranja": "üüß",
        "vermelho": "üü•",
        "prata": "",
        "dourado": "üü®‚ú®"
    }
    return cores_emoji.get(str(cor).lower(), "‚¨ú")

# Paleta de cores para gr√°ficos
PALETA_CORES = {
    "azul": "#3498db",
    "verde": "#2ecc71",
    "amarelo": "#f1c40f",
    "laranja": "#e67e22",
    "vermelho": "#e74c3c",
    "prata": "#bdc3c7",
    "dourado": "#f5c542"
}

st.set_page_config(page_title="Controle de Produ√ß√£o", layout="wide", page_icon="üì¶")

# =======================
# FUN√á√ïES AUXILIARES
# =======================
def carregar_csv(caminho, colunas):
    if os.path.exists(caminho):
        df = pd.read_csv(caminho)
        for col in colunas:
            if col not in df.columns:
                df[col] = ""
        return df
    else:
        return pd.DataFrame(columns=colunas)

def cor_por_data(data):
    dia_semana = data.strftime("%A").lower()
    return CORES_DIAS.get(dia_semana, "sem cor")

def sugestao_produtos():
    if os.path.exists(PRODUCAO_FILE):
        df = pd.read_csv(PRODUCAO_FILE)
        if "produto" in df.columns and not df.empty:
            return sorted(df["produto"].dropna().unique().tolist())
    return []

def verificar_alertas():
    """Verifica produtos pr√≥ximos do vencimento"""
    if not os.path.exists(PRODUCAO_FILE):
        return []
    df = pd.read_csv(PRODUCAO_FILE)
    if "data_validade" not in df.columns:
        return []
    df["data_validade"] = pd.to_datetime(df["data_validade"], errors="coerce")
    hoje = datetime.now()
    alertas = []
    for _, row in df.iterrows():
        if pd.isna(row["data_validade"]):
            continue
        dias = (row["data_validade"] - hoje).days
        cor_emoji = emoji_cor(row.get("cor", ""))
        produto = row.get("produto", "")
        if dias < 0:
            alertas.append(f"‚ùå {produto} ({cor_emoji}) est√° VENCIDO ‚Äî enviar para desperd√≠cio.")
        elif dias == 0:
            alertas.append(f"‚ö†Ô∏è {produto} ({cor_emoji}) vence HOJE ‚Äî verificar remarca√ß√£o.")
        elif dias == 1:
            alertas.append(f"üïí {produto} ({cor_emoji}) vence AMANH√É ‚Äî aten√ß√£o.")
        elif dias <= 3:
            alertas.append(f"‚ö†Ô∏è {produto} ({cor_emoji}) vence em {dias} dias.")
    return alertas

# =======================
# SIDEBAR DE ALERTAS
# =======================
st.sidebar.markdown("### ‚è∞ Alertas de Validade")
alertas = verificar_alertas()
if alertas:
    for a in alertas:
        st.sidebar.warning(a)
else:
    st.sidebar.success("‚úÖ Nenhum produto pr√≥ximo do vencimento.")

# =======================
# MENU PRINCIPAL
# =======================
menu = st.sidebar.radio(
    "üìã Menu",
    [
        "Registrar Produ√ß√£o",
        "Registrar Desperd√≠cio",
        "Gerenciar Validades ‚ôªÔ∏è",
        "Relat√≥rios üìä",
        "Hist√≥rico detalhado üïì",
        "Consultar Produ√ß√£o üîç",
        "Excluir registros üóëÔ∏è",
        "Zerar sistema üßπ"
    ]
)

# =======================
# 1Ô∏è‚É£ REGISTRAR PRODU√á√ÉO
# =======================
if menu == "Registrar Produ√ß√£o":
    st.header("üßÅ Registrar Produ√ß√£o")
    produto = st.text_input("Produto:")
    quantidade = st.number_input("Quantidade produzida:", min_value=1, step=1)
    data = st.date_input("Data de produ√ß√£o:", datetime.now())

    cor = cor_por_data(data)
    data_validade = data + timedelta(days=3)

    st.info(f"üé® Cor autom√°tica: {emoji_cor(cor)} {cor.upper()} ‚Äî Validade: {data_validade.strftime('%d/%m/%Y')}")

    if st.button("‚úÖ Salvar Produ√ß√£o"):
        df = carregar_csv(PRODUCAO_FILE, ["id","data_producao","produto","cor","quantidade_produzida","data_remarcacao","data_validade"])
        novo_id = len(df) + 1
        novo = pd.DataFrame([{
            "id": novo_id,
            "data_producao": data.strftime("%Y-%m-%d"),
            "produto": produto.title(),
            "cor": cor,
            "quantidade_produzida": quantidade,
            "data_remarcacao": "",
            "data_validade": data_validade.strftime("%Y-%m-%d")
        }])
        df = pd.concat([df, novo], ignore_index=True)
        df.to_csv(PRODUCAO_FILE, index=False)
        st.success(f"‚úÖ Produ√ß√£o registrada: {produto} - {quantidade} unidades - Cor: {cor.upper()}")
        st.balloons()

# =======================
# 2Ô∏è‚É£ REGISTRAR DESPERD√çCIO (autom√°tico)
# =======================
elif menu == "Registrar Desperd√≠cio":
    st.header("‚ö†Ô∏è Registrar Desperd√≠cio")

    produtos_cadastrados = sugestao_produtos()
    produto = st.selectbox("Produto (busque ou digite novo):", options=[""] + produtos_cadastrados, index=0)
    produto = produto.strip().title() if produto else ""
    quantidade = st.number_input("Quantidade desperdi√ßada:", min_value=1, step=1)
    motivo = st.text_area("Motivo:")

    if produto:
        prod = carregar_csv(PRODUCAO_FILE, ["id","data_producao","produto","cor","quantidade_produzida","data_validade"])
        producoes_produto = prod[prod["produto"].str.lower().str.contains(produto.lower(), na=False)]
        if not producoes_produto.empty:
            ultima = producoes_produto.iloc[-1]
            st.info(f"üì¶ √öltimo lote: {emoji_cor(ultima['cor'])} {ultima['cor'].upper()} ‚Äî {ultima['data_producao']}")
            st.session_state["ultima_producao_auto"] = ultima.to_dict()
        else:
            st.warning("‚ö†Ô∏è Nenhuma produ√ß√£o encontrada para esse produto.")
            st.session_state["ultima_producao_auto"] = None

    if st.button("‚ö†Ô∏è Salvar Desperd√≠cio"):
        ultima = st.session_state.get("ultima_producao_auto")
        if not produto:
            st.error("‚ùå Informe o produto.")
        elif ultima is None:
            st.error("‚ö†Ô∏è Nenhuma produ√ß√£o encontrada.")
        else:
            disp = carregar_csv(DESPERDICIO_FILE, ["id","data_desperdicio","produto","cor","quantidade_desperdicada","motivo","id_producao","data_producao"])
            novo_id = len(disp) + 1
            data_hoje = datetime.now().strftime("%Y-%m-%d")
            novo = pd.DataFrame([{
                "id": novo_id,
                "data_desperdicio": data_hoje,
                "produto": ultima["produto"],
                "cor": ultima["cor"],
                "quantidade_desperdicada": quantidade,
                "motivo": motivo,
                "id_producao": ultima["id"],
                "data_producao": ultima["data_producao"]
            }])
            disp = pd.concat([disp, novo], ignore_index=True)
            disp.to_csv(DESPERDICIO_FILE, index=False)
            st.success(f"‚ö†Ô∏è Desperd√≠cio salvo: {ultima['produto']} ({emoji_cor(ultima['cor'])} {ultima['cor'].upper()}) - {quantidade} unidades.")
            st.session_state["ultima_producao_auto"] = None
# =======================
# 3Ô∏è‚É£ GERENCIAR VALIDADES (remarca√ß√£o)
# =======================
elif menu == "Gerenciar Validades ‚ôªÔ∏è":
    st.header("‚ôªÔ∏è Remarca√ß√£o de Produtos")

    prod = carregar_csv(PRODUCAO_FILE, [
        "id","data_producao","produto","cor","quantidade_produzida",
        "data_remarcacao","data_validade"
    ])

    if prod.empty:
        st.info("Nenhum produto encontrado.")
    else:
        hoje = datetime.now()
        prod["data_validade"] = pd.to_datetime(prod["data_validade"], errors="coerce")
        prod["dias_restantes"] = (prod["data_validade"] - hoje).dt.days
        prod["Status"] = prod["dias_restantes"].apply(
            lambda d: "‚úÖ Dentro do prazo" if d > 1 else
            ("‚ö†Ô∏è Perto do vencimento" if d == 1 else "‚ùå Vencido")
        )
        prod["Cor (visual)"] = prod["cor"].apply(lambda c: f"{emoji_cor(c)} {c.title()}")

        st.dataframe(
            prod[["id","produto","Cor (visual)","data_producao","data_validade","dias_restantes","Status"]],
            use_container_width=True
        )

        id_remarcar = st.number_input("ID do produto para remarcar:", min_value=1, step=1)
        if st.button("‚ôªÔ∏è Remarcar produto selecionado"):
            if id_remarcar in prod["id"].values:
                hoje = datetime.now()
                prod.loc[prod["id"] == id_remarcar, "data_remarcacao"] = hoje.strftime("%Y-%m-%d")
                prod.loc[prod["id"] == id_remarcar, "data_validade"] = (hoje + timedelta(days=1)).strftime("%Y-%m-%d")
                prod.to_csv(PRODUCAO_FILE, index=False)
                st.success("‚úÖ Produto remarcado com novo prazo de 1 dia.")
            else:
                st.error("‚ùå ID n√£o encontrado.")

# =======================
# 4Ô∏è‚É£ RELAT√ìRIOS üìä
# =======================
elif menu == "Relat√≥rios üìä":
    st.header("üìä Relat√≥rio de Produ√ß√£o x Desperd√≠cio")

    if not os.path.exists(PRODUCAO_FILE):
        st.warning("Nenhuma produ√ß√£o registrada ainda.")
    else:
        prod = pd.read_csv(PRODUCAO_FILE)
        disp = carregar_csv(DESPERDICIO_FILE, [
            "id","data_desperdicio","produto","cor","quantidade_desperdicada",
            "motivo","id_producao","data_producao"
        ])

        resumo_prod = prod.groupby(["cor","produto"])["quantidade_produzida"].sum().reset_index()
        resumo_disp = disp.groupby(["cor","produto"])["quantidade_desperdicada"].sum().reset_index()

        resultado = pd.merge(resumo_prod, resumo_disp, on=["cor","produto"], how="left").fillna(0)
        resultado["% desperd√≠cio"] = (resultado["quantidade_desperdicada"] / resultado["quantidade_produzida"]) * 100
        resultado["Estoque atual"] = resultado["quantidade_produzida"] - resultado["quantidade_desperdicada"]
        resultado["Cor (visual)"] = resultado["cor"].apply(lambda c: f"{emoji_cor(c)} {c.title()}")

        st.dataframe(
            resultado[["Cor (visual)","produto","quantidade_produzida",
                       "quantidade_desperdicada","% desperd√≠cio","Estoque atual"]],
            use_container_width=True
        )

        if not resultado.empty:
            st.subheader("üìâ Gr√°fico de Desperd√≠cio por Cor")
            graf = px.bar(
                resultado,
                x="cor",
                y="% desperd√≠cio",
                color="cor",
                text="% desperd√≠cio",
                title="Percentual de Desperd√≠cio por Cor",
                color_discrete_map=PALETA_CORES
            )
            graf.update_traces(texttemplate='%{text:.1f}%', textposition='outside')
            st.plotly_chart(graf, use_container_width=True)

# =======================
# 5Ô∏è‚É£ HIST√ìRICO DETALHADO üïì
# =======================
elif menu == "Hist√≥rico detalhado üïì":
    st.header("üïì Hist√≥rico detalhado de lan√ßamentos")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üì¶ Produ√ß√£o registrada")
        prod = carregar_csv(PRODUCAO_FILE, [
            "id","data_producao","produto","cor","quantidade_produzida",
            "data_remarcacao","data_validade"
        ])
        if prod.empty:
            st.info("Nenhuma produ√ß√£o registrada.")
        else:
            prod["Cor (visual)"] = prod["cor"].apply(lambda c: f"{emoji_cor(c)} {c.title()}")
            st.dataframe(
                prod[["id","data_producao","produto","Cor (visual)","quantidade_produzida","data_validade"]]
                .sort_values(by="data_producao", ascending=False),
                use_container_width=True
            )

    with col2:
        st.subheader("‚ö†Ô∏è Desperd√≠cio registrado")
        disp = carregar_csv(DESPERDICIO_FILE, [
            "id","data_desperdicio","produto","cor","quantidade_desperdicada",
            "motivo","id_producao","data_producao"
        ])
        if disp.empty:
            st.info("Nenhum desperd√≠cio registrado.")
        else:
            disp["Cor (visual)"] = disp["cor"].apply(lambda c: f"{emoji_cor(c)} {c.title()}")
            st.dataframe(
                disp[["id","data_desperdicio","produto","Cor (visual)",
                      "quantidade_desperdicada","motivo"]]
                .sort_values(by="data_desperdicio", ascending=False),
                use_container_width=True
            )
# =======================
# 6Ô∏è‚É£ CONSULTAR PRODU√á√ÉO üîç
# =======================
elif menu == "Consultar Produ√ß√£o üîç":
    st.header("üîç Consultar produ√ß√µes registradas")

    produtos_cadastrados = sugestao_produtos()
    produto = st.selectbox("Produto (busque ou digite novo):", options=[""] + produtos_cadastrados, index=0)
    produto = produto.strip()
    cor = st.selectbox("Cor (lote):", ["Todas", "azul", "verde", "amarelo", "laranja", "vermelho", "prata", "dourado"])
    data_inicial = st.date_input("Data inicial:", datetime.now().replace(day=1))
    data_final = st.date_input("Data final:", datetime.now())

    if st.button("üîé Buscar"):
        prod = carregar_csv(PRODUCAO_FILE, [
            "id","data_producao","produto","cor","quantidade_produzida","data_validade"
        ])
        if prod.empty:
            st.warning("‚ö†Ô∏è Nenhuma produ√ß√£o registrada ainda.")
        else:
            prod["data_producao"] = pd.to_datetime(prod["data_producao"])
            filtrado = prod[
                (prod["data_producao"] >= pd.to_datetime(data_inicial)) &
                (prod["data_producao"] <= pd.to_datetime(data_final))
            ]
            if produto:
                filtrado = filtrado[filtrado["produto"].str.lower().str.contains(produto.lower(), na=False)]
            if cor != "Todas":
                filtrado = filtrado[filtrado["cor"] == cor]

            if filtrado.empty:
                st.error("‚ùå Nenhuma produ√ß√£o encontrada nesse intervalo.")
            else:
                filtrado["Cor (visual)"] = filtrado["cor"].apply(lambda c: f"{emoji_cor(c)} {c.title()}")
                st.dataframe(
                    filtrado[["id","data_producao","produto","Cor (visual)","quantidade_produzida","data_validade"]],
                    use_container_width=True
                )
                total = filtrado["quantidade_produzida"].sum()
                st.info(f"üì¶ **Total produzido no per√≠odo:** {int(total)} unidades")

# =======================
# 7Ô∏è‚É£ EXCLUIR REGISTROS üóëÔ∏è (vers√£o revisada e funcional)
# =======================
elif menu == "Excluir registros üóëÔ∏è":
    st.header("üóëÔ∏è Excluir lan√ßamentos")

    tipo = st.radio("Escolha o tipo de registro:", ["Produ√ß√£o", "Desperd√≠cio"])

    # Carregar o arquivo certo
    if tipo == "Produ√ß√£o":
        caminho_arquivo = PRODUCAO_FILE
        df = carregar_csv(caminho_arquivo, [
            "id","data_producao","produto","cor","quantidade_produzida","data_validade"
        ])
    else:
        caminho_arquivo = DESPERDICIO_FILE
        df = carregar_csv(caminho_arquivo, [
            "id","data_desperdicio","produto","cor","quantidade_desperdicada",
            "motivo","id_producao","data_producao"
        ])

    # Se n√£o houver registros
    if df.empty:
        st.warning("Nenhum registro encontrado.")
    else:
        df["id"] = pd.to_numeric(df["id"], errors="coerce").fillna(0).astype(int)
        df = df.sort_values(by="id", ascending=True)
        st.dataframe(df, use_container_width=True)

        id_excluir = st.number_input("Digite o ID que deseja excluir:", min_value=1, step=1)
        confirmar = st.checkbox("Confirmar exclus√£o permanente")

        if st.button("üóëÔ∏è Excluir registro selecionado"):
            id_excluir = int(id_excluir)

            if id_excluir not in df["id"].values:
                st.error("‚ùå ID n√£o encontrado.")
            elif not confirmar:
                st.warning("Marque a caixa de confirma√ß√£o antes de excluir.")
            else:
                # Remover o registro e reescrever o CSV
                df_filtrado = df[df["id"] != id_excluir].copy()

                # Reatribuir IDs sequenciais para evitar duplica√ß√£o
                if not df_filtrado.empty:
                    df_filtrado["id"] = range(1, len(df_filtrado) + 1)

                df_filtrado.to_csv(caminho_arquivo, index=False)

                st.success(f"‚úÖ Registro ID {id_excluir} exclu√≠do com sucesso!")
                st.info("Atualize a p√°gina para ver a lista atualizada.")




# =======================
# 8Ô∏è‚É£ ZERAR SISTEMA üßπ
# =======================
elif menu == "Zerar sistema üßπ":
    st.header("üßπ Zerar todos os dados do sistema")
    st.warning("‚ö†Ô∏è Esta a√ß√£o ir√° APAGAR todos os registros de produ√ß√£o e desperd√≠cio permanentemente!")

    confirmar = st.checkbox("Confirmo que desejo apagar TODOS os dados.")
    if st.button("üßπ Zerar agora"):
        if confirmar:
            for file in [PRODUCAO_FILE, DESPERDICIO_FILE]:
                if os.path.exists(file):
                    os.remove(file)
            st.success("‚úÖ Todos os dados foram apagados com sucesso! Sistema zerado.")
            st.toast("Sistema reiniciado com sucesso üöÄ", icon="üßπ")
        else:
            st.warning("Marque a caixa de confirma√ß√£o antes de zerar.")
